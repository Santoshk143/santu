jobs:
- job: Build
  timeoutInMinutes: 0
  pool:
    name: $(AgentPoolName)
    timeoutInMinutes: 0

  workspace:
      clean: all

  variables:
    websitepublishurl: '$(Agent.BuildDirectory)\$(Build.BuildId)'

  steps:
  - checkout: none
    clean: true

  - task: PowerShell@2
    displayName: 'Get Triggered Branch Name'
    inputs:
      targetType: 'inline'
      script: |
        $branchMatch = '$(Build.SourceBranch)'
        Write-Host $branchMatch
        $branchMatch -match 'refs/heads/(?<content>.*)'
        $branchName= $Matches['content']
        Write-Host "##vso[task.setvariable variable=branch_name;]$branchName"
        Write-Host "##vso[task.setvariable variable=Product;]MyCloud"

  - script: |
      git config --system core.longpaths true
      git config --global core.ignorecase true
      git clone https://$(username):$(password)@$(ADOURL)/MyCloud/_git/MyCloudProduct --branch $(branch_name) --depth=1 --single-branch $(Product)

  - task: CopyFiles@1
    displayName: 'Copy Publish Profiles'
    inputs:
      SourceFolder: '$(build.sourcesDirectory)/$(Product)/Devops/PublishProfiles'
      Contents: 'MyCloudWebsiteNew.pubxml'
      TargetFolder: '$(build.sourcesDirectory)/$(Product)/SourceCode/Web/Website/App_Data/PublishProfiles'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CmdLine@2
    displayName: 'Restore Nuget Packages'
    inputs:
      script: |
        nuget restore SourceCode\HCL.CloudBilling.DataCollector\HCL.CloudBilling.DataCollector.sln
        nuget restore SourceCode\HCL.CloudPerformance.DataCollector\HCL.CloudPerformance.DataCollector.sln
        nuget restore SourceCode\HCL.MyCloud.EmbeddedInstaller\HCL.MyCloud.EmbeddedInstaller\HCL.MyCloud.EmbeddedInstaller.sln
        nuget restore SourceCode\HCL.MyCloud.Installer\HCL.MyCloud.Installer.sln
        nuget restore SourceCode\MyCloudListner\HCL.MyCloud.Listner.sln
        nuget restore SourceCode\Services\HCL.MyCloud.AllXaaS\HCL.MyCloud.AllXaaS.sln
        nuget restore SourceCode\Services\HCL.MyCloud.CiscoIntersightSyncService\HCL.MyCloud.CiscoIntersightSyncService.sln
        nuget restore SourceCode\Services\HCL.MyCloud.CustomComplianceJobService\HCL.MyCloud.CustomComplianceJobService.sln
        nuget restore SourceCode\Services\HCL.MyCloud.GenericService\HCL.MyCloud.GenericService.sln
        nuget restore SourceCode\Services\HCL.MyCloud.Monitor\HCL.MyCloud.MonitorService.sln
        nuget restore SourceCode\Services\HCL.MyCloud.Service.AD\HCL.MyCloud.Service.AD.sln
        nuget restore SourceCode\Services\HCL.MyCloud.Snow\HCL.MyCloud.Snow.sln
        nuget restore SourceCode\Services\HCL.MyCloud.SyncComplianceJobService\HCL.MyCloud.SyncComplianceJobService.sln
        nuget restore SourceCode\Services\HCL.MyCloud.SyncJobService\HCL.MyCloud.SyncJobService.sln
        nuget restore SourceCode\Services\HCL.MyCloud.WorkflowEngine\HCL.MyCloud.WorkflowEngine.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.AWSSignatureV4\HCL.MyCloud.AWSSignatureV4.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.ComponentAuthorization\HCL.MyCloud.ComponentAuthorization.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.Encryption\HCL.MyCloud.Encryption.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.GZipEncoder\HCL.MyCloud.GZipEncoder.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.JobServiceContract\HCL.MyCloud.JobServiceContract.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.Log\HCL.MyCloud.Log.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.PowerShell\HCL.MyCloud.PowerShell.sln
        nuget restore SourceCode\Utility\HCL.MyCloud.QueueService\HCL.MyCloud.QueueService.sln
        nuget restore SourceCode\Web\HCL.Autonomics.MyCloud.Portal.sln
      workingDirectory: '$(Build.SourcesDirectory)/$(Product)'

  - task: replacetokens@4
    inputs:
      rootDirectory: '$(build.sourcesDirectory)/$(Product)/SourceCode/Web/Website/App_Data/PublishProfiles'
      targetFiles: 'MyCloudWebsiteNew.pubxml'
      encoding: 'auto'
      tokenPattern: 'default'
      writeBOM: true
      actionOnMissing: 'warn'
      keepToken: false
      actionOnNoFiles: 'continue'
      enableTransforms: false
      useLegacyPattern: false
      enableTelemetry: true
    timeoutInMinutes: 0

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/HCL.MyCloud.Installer/HCL.MyCloud.Installer.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/HCL.MyCloud.Installer/HCL.MyCloud.Installer.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform)

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.Service.AD/HCL.MyCloud.Service.AD.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.Service.AD/HCL.MyCloud.Service.AD.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/HCL.CloudBilling.DataCollector/HCL.CloudBilling.DataCollector.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/HCL.CloudBilling.DataCollector/HCL.CloudBilling.DataCollector.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.GenericService/HCL.MyCloud.GenericService.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.GenericService/HCL.MyCloud.GenericService.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.AllXaaS/HCL.MyCloud.AllXaaS.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.AllXaaS/HCL.MyCloud.AllXaaS.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/MyCloudListner/HCL.MyCloud.Listner.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/MyCloudListner/HCL.MyCloud.Listner.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Web\HCL.MyCloud.Web.WebAPI\HCL.MyCloud.Web.WebAPI.csproj'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Web\HCL.MyCloud.Web.WebAPI\HCL.MyCloud.Web.WebAPI.csproj /p:DeployOnBuild=true /p:Configuration=Release /p:PublishProfile=MyCloudAPI

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Web\Website\website.publishproj'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Web\Website\website.publishproj /p:DeployOnBuild=true /p:PublishProfile=$(build.sourcesDirectory)/$(Product)/SourceCode/Web/Website/App_Data/PublishProfiles/MyCloudWebsiteNew.pubxml

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/HCL.CloudPerformance.DataCollector/HCL.CloudPerformance.DataCollector.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/HCL.CloudPerformance.DataCollector/HCL.CloudPerformance.DataCollector.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.SyncJobService/HCL.MyCloud.SyncJobService.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.SyncJobService/HCL.MyCloud.SyncJobService.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.Snow/HCL.MyCloud.Snow.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.Snow/HCL.MyCloud.Snow.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.SyncComplianceJobService/HCL.MyCloud.SyncComplianceJobService.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.SyncComplianceJobService/HCL.MyCloud.SyncComplianceJobService.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None 

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.CustomComplianceJobService/HCL.MyCloud.CustomComplianceJobService.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.CustomComplianceJobService/HCL.MyCloud.CustomComplianceJobService.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.Monitor/HCL.MyCloud.MonitorService.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.Monitor/HCL.MyCloud.MonitorService.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.WorkflowEngine/HCL.MyCloud.WorkflowEngine.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.WorkflowEngine/HCL.MyCloud.WorkflowEngine.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Web/HCL.MyCloud.Web.Service/HCL.MyCloud.Web.Service.csproj'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Web/HCL.MyCloud.Web.Service/HCL.MyCloud.Web.Service.csproj /p:DeployOnBuild=true /p:Configuration=Release /p:PublishProfile=$(build.sourcesDirectory)/$(Product)/SourceCode/Web/HCL.MyCloud.Web.Service/Properties/PublishProfiles/FolderProfile.pubxml

  - task: CmdLine@2
    displayName: 'Build HCL.MyCloud.UnitTest.csproj'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Web/HCL.MyCloud.UnitTest/HCL.MyCloud.UnitTest.csproj

  - task: VSTest@2
    displayName: 'Run Unit Test Cases'
    inputs:
      testSelector: 'testAssemblies'
      testAssemblyVer2: 'HCL.MyCloud.UnitTest.dll'
      searchFolder: '$(System.DefaultWorkingDirectory)\$(Product)/SourceCode/Web/HCL.MyCloud.UnitTest/bin/Debug'
      vstestLocationMethod: 'location'
      vstestLocation: '$(vstestPath)'
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      codeCoverageEnabled: true

  ################### CiscoIntersightSyncService#################################################

  - task: CmdLine@2
    displayName: 'Build solution SourceCode/Services/HCL.MyCloud.CiscoIntersightSyncService/HCL.MyCloud.CiscoIntersightSyncService.sln'
    inputs:
      script: |
        msbuild $(Product)/SourceCode/Services/HCL.MyCloud.CiscoIntersightSyncService/HCL.MyCloud.CiscoIntersightSyncService.sln /p:Configuration=$(BuildConfiguration) /p:Platform=$(BuildPlatform) /p:DebugSymbols=false /p:DebugType=None

  ################### CiscoIntersightSyncService#################################################
  - task: DeleteFiles@1
    displayName: 'Delete files from $(Build.BinariesDirectory)'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)'
      Contents: '**'

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/MyCloud10.5'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\HCL.MyCloud.Installer\HCL.MyCloud.Installer\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/MyCloud10.5'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/ADService/ADService'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/Services/HCL.MyCloud.Service.AD\HCL.MyCloud.Service.AD\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/ADService/ADService'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/Billing/Billing'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/HCL.CloudBilling.DataCollector\HCL.CloudBilling.DataCollector.Service.Host\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/Billing/Billing'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/GenericService/GenericService'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\Services\HCL.MyCloud.GenericService\HCL.MyCloud.Generic.Host\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/GenericService/GenericService'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/MyCloudListner/MyCloudListener'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\MyCloudListner\HCL.MyCloud.Listner.Service.Host\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/MyCloudListner/MyCloudListener'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/Performance/Performance'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/HCL.CloudPerformance.DataCollector/HCL.CloudPerformance.DataCollector.Service.Host/bin/$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/Performance/Performance'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/ITSMExecutor/ITSMExecutor'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\Services/HCL.MyCloud.Snow/HCL.MyCloud.Snow.Host/bin/$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/ITSMExecutor/ITSMExecutor'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/SyncService/SyncService'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\Services/HCL.MyCloud.SyncJobService/HCL.MyCloud.SyncJobService.Host/bin/$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/SyncService/SyncService'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/WorkFlow/WorkFlow'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\Services/HCL.MyCloud.WorkflowEngine/HCL.MyCloud.WorkflowEngine/bin/$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/WorkFlow/WorkFlow'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(build.binariesdirectory)/Compile/MyCloudPortal/MyCloudPortal/WebUI'
    inputs:
      SourceFolder: '$(websitepublishurl)/website'
      TargetFolder: '$(build.binariesdirectory)/Compile/MyCloudPortal/MyCloudPortal/WebUI'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(build.binariesdirectory)/Compile/MyCloudPortal/MyCloudPortal/WebAPI'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\Web\HCL.MyCloud.Web.WebAPI\bin\Release\PublishOutput'
      TargetFolder: '$(build.binariesdirectory)/Compile/MyCloudPortal/MyCloudPortal/WebAPI'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(build.binariesdirectory)/Compile/MyCloudKRS/MyCloudKRS/KMS'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode\Web\HCL.MyCloud.Web.Service\bin\Release\PublishOutput'
      TargetFolder: '$(build.binariesdirectory)/Compile/MyCloudKRS/MyCloudKRS/KMS'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(build.binariesdirectory)/Compile/Orchestrator/Orchestrator'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/Services/HCL.MyCloud.AllXaaS/HCL.MyCloud.AllXaaS.Host/bin/$(BuildConfiguration)'
      TargetFolder: '$(build.binariesdirectory)/Compile/Orchestrator/Orchestrator'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(build.binariesdirectory)/Compile/HealthMonitor/HealthMonitor'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/Services/HCL.MyCloud.Monitor/HCL.MyCloud.Monitor.Host/bin/$(BuildConfiguration)'
      TargetFolder: '$(build.binariesdirectory)/Compile/HealthMonitor/HealthMonitor'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/ComplianceService/ComplianceService'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/Services/HCL.MyCloud.SyncComplianceJobService\HCL.MyCloud.SyncComplianceJobService.Host\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/ComplianceService/ComplianceService'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/CustomCompliance/CustomCompliance'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/Services/HCL.MyCloud.CustomComplianceJobService/HCL.MyCloud.CustomComplianceJobService.Host\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/CustomCompliance/CustomCompliance'
      OverWrite: true
    timeoutInMinutes: 0

  ########### COPY CiscoIntersightSyncService#########################################################
  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.BinariesDirectory)/Compile/CiscoIntersightSyncService/CiscoIntersightSyncService'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/Services/HCL.MyCloud.CiscoIntersightSyncService\HCL.MyCloud.CiscoIntersightSyncService.Host\bin\$(BuildConfiguration)'
      TargetFolder: '$(Build.BinariesDirectory)/Compile/CiscoIntersightSyncService/CiscoIntersightSyncService'
      OverWrite: true  
  ########### COPY CiscoIntersightSyncService#########################################################

  - task: DeleteFiles@1
    displayName: 'Delete files from $(build.binariesdirectory)/Compile'
    inputs:
      SourceFolder: '$(build.binariesdirectory)/Compile'
      Contents: '**/**/*.pdb'
    timeoutInMinutes: 0

  - task: PowerShell@2
    displayName: 'Update BuildVersion'
    inputs:
      targetType: 'inline'
      script: |
        $text = '$(Build.DefinitionName)_$(Build.DefinitionVersion)_$(Build.BuildId).1'
        Write-Output $text
        $text | Add-Content '$(Build.BinariesDirectory)/Compile/MyCloudListner/MyCloudListener\BuildVersion.txt'
        $text | Add-Content '$(build.binariesdirectory)/Compile/MyCloudPortal/MyCloudPortal/WebUI\BuildVersion.txt'

  - task: ZipDirectory@1
    displayName: 'Zip directories'
    inputs:
      ItemSpec: |
        $(Build.BinariesDirectory)/Compile/ADService/ADService
        $(Build.BinariesDirectory)/Compile/Billing/Billing
        $(Build.BinariesDirectory)/Compile/GenericService/GenericService
        $(Build.BinariesDirectory)/Compile/MyCloudListner/MyCloudListener
        $(Build.BinariesDirectory)/Compile/Performance/Performance
        $(Build.BinariesDirectory)/Compile/ITSMExecutor/ITSMExecutor
        $(Build.BinariesDirectory)/Compile/SyncService/SyncService
        $(Build.BinariesDirectory)/Compile/WorkFlow/WorkFlow
        $(build.binariesdirectory)/Compile/MyCloudPortal/MyCloudPortal
        $(build.binariesdirectory)/Compile/Orchestrator/Orchestrator
        $(build.binariesdirectory)/Compile/MyCloudKRS/MyCloudKRS
        $(build.binariesdirectory)/Compile/HealthMonitor/HealthMonitor
        $(Build.BinariesDirectory)/Compile/ComplianceService/ComplianceService
        $(Build.BinariesDirectory)/Compile/CustomCompliance/CustomCompliance
        $(Build.BinariesDirectory)/Compile/CiscoIntersightSyncService/CiscoIntersightSyncService

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/MyCloud10.5'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
    timeoutInMinutes: 0

  - task: CopyFiles@2
    displayName: 'Copy GenerateObjectSqlCopy.Bat to file folder'
    inputs:
      SourceFolder: '$(build.SourcesDirectory)/$(Product)/SourceCode/HCL.MyCloud.Installer/HCL.MyCloud.Installer/Files'
      Contents: 'GenerateObjectSqlCopy.Bat'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/ComplianceService'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/ComplianceService'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/ComplianceService'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/ADservice'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/ADService'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/ADservice'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/Billing'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/Billing'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/Billing'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/MyCloudListener'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/MyCloudListner'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/MyCloudListener'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/GenericService'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/GenericService'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/GenericService'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/Performance'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/Performance'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/Performance'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/WorkFlow'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/WorkFlow'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/WorkFlow'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/SyncService'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/SyncService'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/SyncService'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/ITSMExecutor'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/ITSMExecutor'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/ITSMExecutor'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/MyCloudPortal'
    inputs:
      SourceFolder: '$(build.binariesdirectory)/Compile/MyCloudPortal'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/MyCloudPortal'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/DBScript'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/$(Product)/SourceCode/DataBase'
      Contents: '**\*'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/DBScript'
      OverWrite: true
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/Orchestrator'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/Orchestrator'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/Orchestrator'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/Prerequisites'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/$(Product)/SourceCode/Prerequisites'
      Contents: '**\*'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/Prerequisites'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/MyCloudKRS'
    inputs:
      SourceFolder: '$(build.binariesdirectory)/Compile/MyCloudKRS'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/MyCloudKRS'
    timeoutInMinutes: 0

  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/HealthMonitor'
    inputs:
      SourceFolder: '$(build.binariesdirectory)/Compile/HealthMonitor'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/HealthMonitor'
      OverWrite: true
    timeoutInMinutes: 0
  
  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/CustomCompliance'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/CustomCompliance'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/CustomCompliance'
      OverWrite: true
    timeoutInMinutes: 0

  ####copy zip files for CiscoIntersightSyncService#######
  - task: CopyFiles@1
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/Files/CiscoIntersightSyncService'
    inputs:
      SourceFolder: '$(Build.BinariesDirectory)/Compile/CiscoIntersightSyncService'
      Contents: '*.zip'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/Files/CiscoIntersightSyncService'
      OverWrite: true
    timeoutInMinutes: 0
  #########################################################

  - task: PowerShell@2
    displayName: 'Generate BuildAndVersionDetail.txt'
    inputs:
      targetType: 'inline'
      script: |
        $text = 'BuildNumber : $(Build.BuildId)|VersionNumber : $(project_version)'
        Write-Output $text     
        $text | Add-Content '$(Build.ArtifactStagingDirectory)/Files/BuildAndVersionDetail.txt'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: MyCloudInstaller'
    inputs:
      ArtifactName: MyCloudInstaller
    timeoutInMinutes: 0
    
  - task: DeleteFiles@1
    displayName: 'Delete files from $(build.sourcesDirectory)/$(Product)/CIInstaller'
    inputs:
      SourceFolder: '$(websitepublishurl)/Website'
      Contents: '**'
    enabled: true
    condition: succeededOrFailed()
    timeoutInMinutes: 0
